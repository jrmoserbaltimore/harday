% vim: sw=4 ts=4 et

\begin{tikzpicture}[
        every node/.append style={align=center, minimum width=2cm, minimum height=2cm,fill=white},
        straight arrow/.style={-{Latex[length=2mm]}},
        symbol node/.append style={minimum width = 0.0cm, minimum height=0.0cm, inner sep=-0.1cm, outer sep=0cm, align=center, draw=none},
        DPW/.append style={fill=Emerald!50},
        differencer/.append style={minimum height=1cm,fill=Red!45}
    ]
    \footnotesize
    \matrix[draw, column sep=0.5cm, row sep=0.5cm, nodes=draw, fill=SkyBlue] (Tone Generator)
    {
    & \node[DPW] (DPW2) {DPW2\\Polynomial};
      & \node[symbol node, circle, font={\Huge}] (DPW2 Sum) {$\oplus$};
      & \node[differencer] (DPW2 Differentiator) {Differentiator};
      & \node[symbol node,circle, font={\Huge}] (DPW2 Scale) {$\otimes$}; \\
      		\node (registers) {Control\\Registers};
      & \node[minimum height=1cm, fill=Peach!50] (accumulator) {Phase\\Accumulators};
      & \node[draw=none, outer sep=0, minimum width=0, fill=none] (Tone LFO) {from\\LFO};
      & &\node[symbol node, circle, font={\Huge}] (Tone Sum) {$\oplus$}; \\
     & \node[DPW] (DPW4) {DPW4\\Polynomial};
       & \node[symbol node, circle, font={\Huge}] (DPW4 Sum) {$\oplus$};
       & \node[differencer] (DPW4 Differentiator) {Differentiator};
       & \node[symbol node, circle, font={\Huge}] (DPW4 Scale) {$\otimes$}; \\
    };
    \draw[straight arrow] (accumulator.north) -- (DPW2.south);
    \draw[straight arrow] (accumulator.south) -- (DPW4.north);
    %\draw[straight arrow] (registers.north) |- (DPW2.west);
    %\draw[straight arrow] (registers.south) |- (DPW4.west);
    \draw[straight arrow] (registers.east) -- (accumulator.west);
    \draw[straight arrow] (Tone LFO.west) -- (accumulator.east);

    \draw[straight arrow] (DPW2.east) -- (DPW2 Sum.west);
    \draw[straight arrow] (DPW2.east) ++(0,0.75cm) -| (DPW2 Sum.north);
    \draw[straight arrow] (DPW4.east) -- (DPW4 Sum.west);
    \draw[straight arrow] (DPW4.east) ++(0,-0.75cm) -| (DPW4 Sum.south);
    \draw[straight arrow] (DPW2 Sum.east) -- (DPW2 Differentiator.west);
    \draw[straight arrow] (DPW4 Sum.east) -- (DPW4 Differentiator.west);
    \draw[straight arrow] (DPW2 Differentiator.east) -- (DPW2 Scale.west);
    \draw[straight arrow] (DPW4 Differentiator.east) -- (DPW4 Scale.west);
    \draw[straight arrow] (DPW2 Scale.south) -- (Tone Sum.north);
    \draw[straight arrow] (DPW4 Scale.north) -- (Tone Sum.south);

    %%% LFO and noise generator

    \matrix[column sep=0.5cm, row sep=0.5cm, nodes=draw, anchor=north west]
    (LFO Section) at ($(Tone Generator.south west) + (0, -1cm)$)
    {
        \node(Noise Shifter) {Noise Shifter}; & \node[fill=Black,text=white] (LFO) {\textbf{LFO}}; \\
    };

    \matrix[draw, column sep=0.5cm, row sep=0.5cm, nodes=draw, anchor=north east, fill=Green]
    (Envelope Generator Section) at ($(Tone Generator.south east) + (0, -1cm)$)
    {
        \node (Envelope Counter) {Envelope\\Counter}; & \node(Envelope Mask) {Mask\\Generator}; \\
    };

    \draw[straight arrow] (Envelope Counter.east) -- (Envelope Mask.west);

    \node[symbol node, circle, font={\Huge}, anchor=center] (Noise Sum)
      at ($(Tone Generator.south east) + (1cm,-0.5cm)$){$\oplus$};
    \draw[straight arrow] (Noise Shifter.north) |- (Noise Sum.west);
    \draw[straight arrow] (Tone Sum.east) -| (Noise Sum.north);

    \node[symbol node, circle, font={\Huge}, anchor=center] (Envelope Multiplier)
    at (Noise Sum|-Envelope Mask) {$\otimes$};
    \draw[straight arrow] (Noise Sum.south) -- (Envelope Multiplier.north);
    \draw[straight arrow] (Envelope Mask.east) -- (Envelope Multiplier.west);

    \node[draw, anchor=north west, fill=Apricot] (Filter)
      at ($(LFO Section.south west) + (0, -1cm)$) {State\\Variable\\Filter};
    \node[symbol node, circle, font={\Huge}, anchor=center] (AM Multiplier)
      at (LFO|-Filter) {$\otimes$};

    \draw[straight arrow] (LFO.south) -- (AM Multiplier.north);
    \draw[straight arrow] (Envelope Multiplier.south) |- (AM Multiplier.east);
    \draw[straight arrow] (AM Multiplier.west) -- (Filter.east);
    \draw[straight arrow] ($(Filter.east) + (0,-0.5cm)$) -- ++(10cm,0);

\end{tikzpicture}
