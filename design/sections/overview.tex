% vim: set sw=4 ts=4 et

\chapter{Overview}

\projectname{ }implements a configuration-compatible AY-3-8930 \autocite{AY38930ds} and YM2149 \autocite{YM2149ds} synthesizer core in Amaranth HDL.  It starts in the the AY-3-8910 compatibility mode and the mode select to AY-3-8930 expanded capability mode, as per the AY-3-8930.

\projectname{ }uses information from the Mame source code, but does not use the Mame source code itself and is not supported by Mame.

As per the AY-3-8930, writing $'b101$ to R15 B7-B5 selects the 8930 expanded mode.  In expanded mode, writing $'b1010$ to R15 B7-B4 selects register bank 0, and writing $'b1011$ to R15 B7-B4 selects register bank 1.  Additionally, writing $'b0001$ to R15 B7-B4 selects YM2149F mode.

\begin{tabular}{|c|c|c|}
    \hline
    Mode & B7-B5 & B4 \\
    \hline
    8910 & All undefined values & x \\
    \hline
    8910 & 'b000 & 'b0 \\
    \hline
    YM2149F & 'b000 & 'b1 \\
    \hline
    8930 extended & 'b101 & x \\
    \hline
    Enhanced & 'b110 & x \\
    \hline
    Enhanced Page 3-4 & 'b111 & x \\
    \hline
\end{tabular}

\section{Enhanced Mode}

Enhanced mode extends the duty cycle registers to 8 bit and adds amplitude modulation, vibrato, and duty cycle modulation via three LFOs indexed 0 (disable), 1, 2, or 3.  A chorus effect is also provided, which when enabled generates a duplicate signal for the given channel, without vibrato, such that applying vibrato to the channel creates a chorus effect.  Three Chamberlin state variable filters (SVF) are also provided.  Each channel can select directly from the ramp, square, or triangle waveforms.

The envelope counter is 8 bit in enhanced mode.  Levels can be masked by a priority decoder, converting a 3-bit input into an AND mask.  The 3-bit input is decoded by a binary decoder; each output is ORed with the next-lower output.  For example, an input of $'b101$ (5) sets bit 5, which causes bits 6 and 7 to be set, resulting in $'b1110000$.  This result is ANDed with the envelope counter to produce the final envelope count, in this case producing a 3-bit counter by masking off the lower 5 bits.

These extensions greatly expand the range of timbres produced by the AY-3.  AM and fine-grained duty cycle control can create a large amount of harmonic distortion effects; the vibrato effect is the foundation for the chorus effect, which creates a glassy tone.  Masking the envelope counter can achieve the behavior of the AY-3-8910's 4-bit EC (mask=$'b100$) or the AY-3-8930's 5-bit extended mode counter (mask=$'b011$), or other timbres.

The Chamberlin state variable filters digitally model the nonlinearity of many older sound generators such a the 2A03, SN76489, AY-3-8930, and SID, and expose the internal registers to the user.  There are no modulation controls over the registers; all poles, zeroes, and resonances must be directly set, and values must be calculated by the programmer.

These enhanced features require minimal additional circuitry, and would be appropriate for a 1980-era digital sound generator.

Beyond this, a 4-bit read-write register in the last register page acts as a register file selector.  When loaded with a value, it checks if that value is greater than the total register files; if so, it loads the register with the highest register file available.  The Enhanced mode can support up to 16 register files, which act as independent AY-3-8930 Enhanced tone generators, making the register file select analogous to a chip select; however, mode select can only be done on register file zero.  This allows for up to 48 independent channels to be implemented, or as few as only 3 independent channels by not implementing any register files beyond file zero, with a method for software to query the chip's capabilities.

\section{Block Diagram}

% Major components:
%
%  - Control registes
%  - Tone generators
%    - Phase accumulators
%    - Differentiated Polynomial Generator
%  - LFOs
%  - Noise shifter
%  - Envelope generator
%    - Envelope counter
%    - Mask generator
%  - Filters
%
% Components of the Differentiated polynomial generator:
%
%  - Phase input
%  - LFO input
%  - Sample register (holds last sample and differences)
%  - Differentiator
%  - Scaling correction
%
% Differentiated polynomial generator handles a lot of the tone shaping:
%
%  - The pulse wave duty cycle is controlled by generating two saw waves,
%    and phase-shifting one of these.
%  - Duty cylcle modulation is handled by phase modulation of one of the
%    saw waves.
%  - Vibrato is handled by frequency modulation, slightly reducing or
%    increasing the rate of phase accumulation.
%  - Chorus is handled by wet/dry mixing of vibrato and non-vibrato
%    waveforms, meaning four saw waves are generated per channel.
%  - This also means saw waves can be generated by not mixing the pulse
%    wave component.
%  - A square wave (50% duty cycle pulse) can be fed to a simple
%    integrator and an accumulator, then given frequency-dependant
%    scaling, to produce a triangle wave.
%
% This is relatively complex because digitally-generated trivial
% waveforms have severe aliasing; see Välimäki et al for DPW alias
% suppression.  Fortunately, this is just a matter of generating a
% large quantity of waveforms in a pipeline, not extra hardware beyond
% basic square waveform generation.  More phase accumulators and sample
% registers are needed for each channel, but not more computation
% circuitry.

\begin{figure}[h!t]
    \centering
    \input{diagrams/block-diagram.tex}
    \caption{\label{fig:block-diagram} Full block diagram.  The DPW polynomial unit generates four polynomials per channel, which are summed and then differentiated.}
\end{figure}

\section{Tone Generation}

Each channel can generate a ramp, pulse, or triangle waveform.  To compensate for the aliasing in digital waveform generation, these waveforms are generated by differentiating polynomial functions using the differential polynomial waveform (DPW) method\autocite{Valimaki2010}.

For a given order $N$, a polynomial and a scaling factor are required.  The operations for these are shown below.

\begin{tabular}{|c|c|c|c|c|c|c|}
	\hline
	Order & Polynomial & FMA & MUL & ADD & Scaling & MUL \\
	\hline
	1 & $x$ & 0 & 0 & 0 & 1 & 0 \\
	\hline
	2 & $x^2$ & 0 & 1 & 0 & $\pi csc(f_0\frac{\pi}{f_s})2^{-2}$ & 2  \\
	\hline
	3 & $(x^2-1)x$ & 1 & 1 & 0 & $\frac{\pi^2}{6}csc(f_0\frac{\pi}{f_s})^22^{-2}$ & 3 \\
	\hline
	4 & $(x^2-2)x^2$ & 0 & 2 & 1 & $\frac{\pi^3}{24}csc(f_0\frac{\pi}{f_s})^32^{-3}$ & 4 \\
	\hline
	5 & $((x^2-\frac{10}{3})x^2-\frac{7}{3})x$ & 1 & 2 & 1 & $\frac{\pi^4}{120}csc(f_0\frac{\pi}{f_s})^42^{-4}$ & 4 \\
	\hline
	6 & $((x^2-5)x^2+7)x^2$ & 1 & 2 & 1 & $\frac{\pi^5}{720}csc(f_0\frac{\pi}{f_s})^52^{-5}$ & 5 \\
	\hline
\end{tabular}

Scaling is complex, and computing $csc(\theta)$ for small values of $\theta$ requires a full division or other computationally complex operation.  Instead, a look-up table containing values for scaling function $s(f_0)$ and $s'(f_0)$ is used, computing $L_s(f_0)=s(trunc(f_0))+s'(trunc(f_0))(f_0-trunc(f_0))$ where $trunc()$ truncates $f_0$ to align with the look-up table entries.  A look-up table aligned to 1Hz crosses 1\% error at 26Hz; aligned to 2Hz, it crosses 1\% error at 52Hz.

The table requires entries up to at least 4200Hz, the highest key on the piano; however, approximating from $f_0=4096$ gives an error of only 0.39\% at 4200 and crosses 1\% at 4260Hz, as the slope of $s(f_0)$ becomes more shallow as $f_0$ increases.  Using a resolution of one entry every 32Hz, the error at 2048Hz is only 0.15\%, much lower than the 1\% error at 26Hz when using a resolution of 1Hz.  As such, precision can be improved by using a series of 64-entry tables of decreasing resolution, for the range 16-32Hz; 32-64Hz; 64-128Hz; 128-256Hz; 256-512Hz; 512-1024Hz; 1024-2048Hz; and 2048-4096Hz.  This totals 8 tables and 512 entries, and does not cross above 0.5\% error; the error at A0 is 0.15\%.

This scaling approach requires one look-up, one multiplication, and two additions.


The DPW generator only generates ramps.  Square and PWM are generated by subtracting a ramp from itself phase shifted, with the shift representing the duty cycle.  Triangle waveforms are the integral of square waveforms, and integrating a PWM with a non-square duty cycle moves the peak of the triangle horizontally through its period.

Because $\frac{d}{dx}f(x)+\frac{d}{dx}g{x}=\frac{d}{dx}(f(x)+g(x))$, differencing the sum of the polynomial functions is the same as summing the differences of the polynomial functions, reducing the amount of storage and computation hardware required.  Likewise, rather than taking the difference and then integrating the result, we can skip the final differencing to get the integral value.  The pipeline handles this by checking if we are generating a triangle wave and, if so, subtracting zero rather than the prior sample in the last differencing step.

Välimäki et al suggest avoiding scaling costs at low frequencies by mixing a fourth-order and second-order generator at a cross-over point of around 500Hz\autocite{Valimaki2010}.  At 27.5Hz--A\textsubscript{0}, the lowest standard piano key--second-order DPW requires a scale factor of $2^{8.8}$, while fourth-order DPW requires a scale factor of $2^{24.7}$.  Rather than implementing the additional adders, multipliers, differencers, and registers for an additional generator, along with mixing circuitry and decision-making circuitry to determine the correct mix, the tone generator expands the fourth-order DPW pipeline bit width by an additional 25 bits, and then reduces the bit depth after scaling.

\begin{figure}[h!t]
	\centering
	\input{diagrams/dpw-mixed-blockdiagram.tex}
	\caption{A combined DPW2/DPW4 tone generator, as recommended by Välimäki et al.  The $x^2$ term is used for both.  DPW2 adds an extra differencer, scaling multiplier, scaling factor calculator, mixing balance calculator, and two more multipliers to balance the scaled waveforms.  Using only DPW4 down to 27.5Hz (A0) instead requires extending the three multipliers, four adders, and three delay registers to be 11 bits wider.}
\end{figure}

The polynomial generator generates two polynomial waveforms per each of three channels, requiring storage of six waveform states.  The two polynomial waveforms are themselves generated from two waveforms each, so twelve waveforms are generated per sample.

\section{Noise Shifter}

The noise shifter works in the same way as the AY-3-8930, with AY-3-8910 mode configuration in compatibility mode.

% TODO:  Fully explain and diagram the noise shifter.
\section{Envelope Generator}

The envelope generator is identical to the AY-3-8930 EG, except that in enhanced mode it has an 8-bit envelope counter that can be masked to fewer bits.