% vim: set sw=4 ts=4 et

\chapter{Overview}

\projectname{ }implements a configuration-compatible AY-3-8930 and YM2149F synthesizer core in Amaranth HDL.  It starts in the the AY-3-8910 compatibility mode and the mode select to AY-3-8930 expanded capability mode, as per the AY-3-8930.

\projectname{ }uses information from the Mame source code, but does not use the Mame source code itself and is not supported by Mame.

As per the AY-3-8930, writing $'b101$ to R15 B7-B5 selects the 8930 expanded mode.  In expanded mode, writing $'b1010$ to R15 B7-B4 selects register bank 0, and writing $'b1011$ to R15 B7-B4 selects register bank 1.  Additionally, writing $'b0001$ to R15 B7-B4 selects YM2149F mode.

\begin{tabular}{|c|c|c|}
    \hline
    Mode & B7-B5 & B4 \\
    \hline
    8910 & All undefined values & x \\
    \hline
    8910 & 'b000 & 'b0 \\
    \hline
    YM2149F & 'b000 & 'b1 \\
    \hline
    8930 extended & 'b101 & x \\
    \hline
    Enhanced & 'b110 & x \\
    \hline
    Enhanced Page 3-4 & 'b111 & x \\
    \hline
\end{tabular}

\section{Enhanced Mode}

Enhanced mode extends the duty cycle registers to 8 bit and adds amplitude modulation, vibrato, and duty cycle modulation via three LFOs indexed 0 (disable), 1, 2, or 3.  A chorus effect is also provided, which when enabled generates a duplicate signal for the given channel, without vibrato, such that applying vibrato to the channel creates a chorus effect.  Three Chamberlin state variable filters (SVF) are also provided.  Each channel can select directly from the ramp, square, or triangle waveforms.

The envelope counter is 8 bit in enhanced mode.  Levels can be masked by a priority decoder, converting a 3-bit input into an AND mask.  The 3-bit input is decoded by a binary decoder; each output is ORed with the next-lower output.  For example, an input of $'b101$ (5) sets bit 5, which causes bits 6 and 7 to be set, resulting in $'b1110000$.  This result is ANDed with the envelope counter to produce the final envelope count, in this case producing a 3-bit counter by masking off the lower 5 bits.

These extensions greatly expand the range of timbres produced by the AY-3.  AM and fine-grained duty cycle control can create a large amount of harmonic distortion effects; the vibrato effect is the foundation for the chorus effect, which creates a glassy tone.  Masking the envelope counter can achieve the behavior of the AY-3-8910's 4-bit EC (mask=$'b100$) or the AY-3-8930's 5-bit extended mode counter (mask=$'b011$), or other timbres.

The Chamberlin state variable filters digitally model the nonlinearity of many older sound generators such a the 2A03, SN76489, AY-3-8930, and SID, and expose the internal registers to the user.  There are no modulation controls over the registers; all poles, zeroes, and resonances must be directly set, and values must be calculated by the programmer.

These enhanced features require minimal additional circuitry, and would be appropriate for a 1980-era digital sound generator.

Beyond this, a 4-bit read-write register in the last register page acts as a register file selector.  When loaded with a value, it checks if that value is greater than the total register files; if so, it loads the register with the highest register file available.  The Enhanced mode can support up to 16 register files, which act as independent AY-3-8930 Enhanced tone generators, making the register file select analogous to a chip select; however, mode select can only be done on register file zero.  This allows for up to 48 independent channels to be implemented, or as few as only 3 independent channels by not implementing any register files beyond file zero, with a method for software to query the chip's capabilities.

\section{Block Diagram}

% TODO:  Block diagram goes here.
%
% Major components:
%
%  - Control registes
%  - Envelope generator
%    - Envelope counter
%    - Mask generator
%  - Noise shifter
%  - Tone generators
%    - Phase accumulators
%    - Differentiated Polynomial Generator
%  - LFOs
%  - Filters
%
% Components of the Differentiated polynomial generator:
%
%  - Phase input
%  - LFO input
%  - Sample register (holds last sample and differences)
%  - Differentiator
%  - Scaling correction
%
% Differentiated polynomial generator handles a lot of the tone shaping:
%
%  - The pulse wave duty cycle is controlled by generating two saw waves,
%    and phase-shifting one of these.
%  - Duty cylcle modulation is handled by phase modulation of one of the
%    saw waves.
%  - Vibrato is handled by frequency modulation, slightly reducing or
%    increasing the rate of phase accumulation.
%  - Chorus is handled by wet/dry mixing of vibrato and non-vibrato
%    waveforms, meaning four saw waves are generated per channel.
%  - This also means saw waves can be generated by not mixing the pulse
%    wave component.
%  - A square wave (50% duty cycle pulse) can be fed to a simple
%    integrator and an accumulator, then given frequency-dependant
%    scaling, to produce a triangle wave.
%
% This is relatively complex because digitally-generated trivial
% waveforms have severe aliasing; see Välimäki et al for DPW alias
% suppression.  Fortunately, this is just a matter of generating a
% large quantity of waveforms in a pipeline, not extra hardware beyond
% basic square waveform generation.  More phase accumulators and sample
% registers are needed for each channel, but not more computation
% circuitry.
%

\section{Tone Generation}

Each channel can generate a ramp, pulse, or triangle waveform.  To compensate for the aliasing in digital waveform generation, these waveforms are generated by differentiating polynomial functions using the differential polynomial waveform (DPW) method\autocite{Valimaki2010}.

\begin{figure}[ht]
    \centering
    \input{diagrams/tone-generator-block-diagram.tex}
    \caption{\label{fig:tone-generator-block-diagram}Tone generator block diagram.  Each DPW polynomial unit generates four polynomials, which are summed and differentiated, then scaled and summed.}
\end{figure}

The DPW generator only generates ramps.  Square and PWM are generated by subtracting a ramp from itself phase shifted, with the shift representing the duty cycle.  Triangle waveforms are the integral of square waveforms, and integrating a PWM with a non-square duty cycle moves the peak of the triangle horizontally through its period.

Because $\frac{d}{dx}f(x)+\frac{d}{dx}g{x}=\frac{d}{dx}(f(x)+g(x))$, differencing the sum of the polynomial functions is the same as summing the differences of the polynomial functions, reducing the amount of storage and computation hardware required.  Likewise, rather than taking the difference and then integrating the result, we can skip the final differencing to get the integral value.  The pipeline handles this by checking if we are generating a triangle wave and, if so, subtracting zero rather than the prior sample in the last differencing step.

Due to scaling costs at lower frequencies, the signal is mixed from a fourth-order DPW and a second-order DPW around the 1,000Hz mark.  Fourth-order

A total of four polynomial generators generate two waveforms per each of three channels, requiring storage of six waveform states.


